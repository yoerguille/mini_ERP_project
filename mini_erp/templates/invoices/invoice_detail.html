{% extends "general/layout.html" %}

{% block head_title %} Invoice Detail {% endblock %}

{% block contenido %}

{% load static %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="{% static 'orders/css/orders.css' %}">
<div class="container my-4">
    {% include "_includes/_messages.html" %}

    <!-- CABECERA -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">
                Factura {{ object.invoice_number }}
            </h2>
            <small class="text-muted">
                Pedido relacionado:
                <a href="{% url 'orders:order_detail' object.order.pk %}">
                    {{ object.order.title }}
                </a>
            </small>
        </div>

        <div>
            <span class="badge 
                {% if invoice.status == 'DRAFT' %} bg-secondary
                {% elif invoice.status == 'ISSUED' %} bg-primary
                {% elif invoice.status == 'PAID' %} bg-success
                {% endif %}
                fs-6">
                {{ object.get_status_display }}
            </span>
        </div>
    </div>

    <!-- DATOS DE FACTURACIÓN -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6 class="text-uppercase text-muted">Datos de facturación</h6>
                    <p class="mb-1"><strong>{{ object.client_name }}</strong></p>
                    <p class="mb-1">{{ object.client_adress }}</p>
                    <p class="mb-1">{{ object.cifnif }}</p>
                    <p class="mb-1">{{ object.billing_email }}</p>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h6 class="text-uppercase text-muted">Factura</h6>
                    <p class="mb-1">
                        <strong>Fecha:</strong> {{ object.issue_date|date:"d/m/Y" }}
                    </p>
                    <p class="mb-1">
                        <strong>Estado:</strong> {{ object.get_status_display }}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- LÍNEAS DE FACTURA -->
    <div class="card shadow-sm mb-4">
        <div class="card-body p-0">
            <table class="table table-striped mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Concepto</th>
                        <th class="text-center">Cantidad</th>
                        <th class="text-end">Precio unitario</th>
                        <th class="text-end">Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in object.items.all %}
                        <tr>
                            <td>{{ item.description }}</td>
                            <td class="text-center">{{ item.quantity }}</td>
                            <td class="text-end">{{ item.unit_price }} €</td>
                            <td class="text-end fw-bold">
                                {{ item.total }} €
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="4" class="text-center text-muted py-4">
                                No hay líneas de factura todavía
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- TOTALES -->
    <div class="row justify-content-end mb-4">
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <span>Base imponible</span>
                        <strong>{{ object.base_amount }} €</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>IVA (21%)</span>
                        <strong>{{ object.vat_amount }} €</strong>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between fs-5">
                        <span>Total</span>
                        <strong>{{ object.total_with_vat }} €</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ACCIONES -->
    <div class="d-flex gap-2">
        {% if object.status == 'DRAFT' %}
          <a href="{% url 'invoices:invoice_draft' object.pk %}" class="btn btn-outline-primary">
            + Añadir/- Eliminar línea
            </a>
        {% endif %}

        {% if object.status == 'DRAFT' %}
        
        <a href="{% url 'invoices:invoice_update' object.pk %}" class="btn btn-secondary">
            Editar Datos de Facturación
        </a>
        {% endif %}


        {% if invoice.status == 'DRAFT' %}
            <a href="{% url 'invoices:invoice_issue' object.pk %}" class="btn btn-success">
                Emitir factura
            </a>
        {% endif %}

        <a href="{% url 'invoices:invoice_list' %}" class="btn btn-outline-secondary">
            Volver a lista de Facturas
        </a>

        <form action="{% url 'invoices:invoice_send_email' object.pk %}" method="post">
            {% csrf_token %}
            <button type="submit"> Enviar factura cliente</button>

        </form>

        <a href="{% url 'invoices:invoice_pdf_download' object.pk %}"
            class="btn btn-outline-primary"
            target="_blank"
        >
            Descargar Factura PDF

        </a>

    </div>

</div>
{% endblock %}